<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>For the north</title>
  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
  <link rel="stylesheet" href="/for-the-north-static/public/prism.css">
  <link rel="stylesheet" href="/for-the-north-static/public/styles.css">
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
</head>
<body>
  <nav class="navbar">
    <a class="logo" href="/for-the-north-static/pages/index.html">
        <strong>FTN</strong>
    </a>
  </nav>
  <aside class="sidebar">
    <a class="nav-link" href="/for-the-north-static/pages/posts.html">Posts</a>
    <a class="nav-link" href="/for-the-north-static/pages/about.html">About</a>
  </aside>
  <main class="main post-body">
    <h2 class="post-headline">
      Prototypes, feared by many, dominated by a few.
    </h2>
    <p>
      Even with all the hype that many of us OOP programmers out there trying
      to get our ways, and implement our beloved patterns, it seems difficult
      even to use the most simple features of JavaScript along this paradigm.
    </p>
    <p>
      Don't worry, I understand.
    </p>
    <p>
      But when dark times come, these usually bring people that have experienced
      some sort of this cloudy and shadow neighborhoods that make us tremble when
      the project manager says:
    </p>
    <p class="dialog">
        "Hey, we are getting some issues in the product page,
        would you mind taking a look?"
    </p>
    <p class="sneaky-action">
        * project manager flees and leaves you to die*
    </p>
    <p>
      So, let's get started for once.
    </p>
    <p>
      Prototypes pretty much work the same way as object instances in <span id="code-tag-1" class="code">Java/C#/PHP</span> do.
    </p>
    <p>
      You add a few "attributes" and "methods" to have some features and functionality or behavior going, and you're good to go.
    </p>
    <p>
      Things get fuzzy when we attempt to mess with the word <span id="code-tag-2" class="code">this</span>.
    </p>
    <p>
      First, to wrap our heads around this, we must run into some
      samples so we can put our terms over the table and actually
      see what's going on. Suppose we have the following code samples:
    </p>
    <h3>ES5</h3>
    <div class="code-section">
        <input type="checkbox" class="collapse-checkbox" id="collapse-1">
        <label class="collapse-toggle" for="collapse-1" title="Click to toggle expand/collapse">
        </label>
        <pre class="collapse-content">
        <code class="code language-javascript">
          function Person(name){
            this.name = name
            this.sayHi = function() {
              console.log("Hi! I'm " + this.name)
            }
          }
  
          var johnSmith = new Person()
          johnSmith.sayHi()
        </code>
      </pre>
    </div>
    <h3>ES6</h3>
    <div class="code-section">
        <input type="checkbox" class="collapse-checkbox" id="collapse-2">
        <label class="collapse-toggle" for="collapse-2" title="Click to toggle expand/collapse">
        </label>
        <pre class="collapse-content">
        <code class="code language-javascript">
          class Person {
            constructor(name) {
              this.name = name
            }

            sayHi() {
              console.log(`Hi! I'm ${this.name}`)
            }
          }

          const johnSmith = new Person()
          johnSmith.sayHi()
        </code>
      </pre>
    </div>

    <p>
      A pretty normal code if you ask me.
      Nothing wrong with it. You can get out even
      by just calling <code>johnSmith.sayHi()</code>
      and you're good to go. Both samples are just fine.
    </p>
    <p>
      Now, let's get further.
      What would happen if we wanted to create a special
      prototype to handle a few click events from a page?
      Let's take a look:
    </p>
    <p>
      <div class="code-section">
            <input type="checkbox" class="collapse-checkbox" id="collapse-4">
            <label class="collapse-toggle" for="collapse-4" title="Click to toggle expand/collapse">
            </label>
            <pre class="collapse-content">
            <code class="code language-javascript">
              // JavaScript: index.js
              class ClickListener {
                constructor(button) {
                  this.button = button
                  this.counter = 0
                  this.button.addEventListener('click', this.handleClick)
                }

                handleClick() {
                  this.counter++
                  const counterHolder = document.querySelector('#counter')
                  counterHolder.innerHTML = `You clicked ${this.counter} times`
                }
              }

              const button = document.querySelector('#count-button')
              const listener = new ClickListener(button)
            </code>

            <code class="code language-html">
              &lt;!--HTML: index.html --&gt;
                  &lt;html&gt;
                    &lt;head&gt;&lt;/head&gt;
                    &lt;body&gt;
                      &lt;div&gt;
                        &lt;input type="button" id="count-button"&gt;
                        &lt;div id="counter" &gt;
                          You clicked 0 times
                        &lt;/div&gt;
                      &lt;/div&gt;
                    &lt;script src="./index.js"&gt;&lt;/script&gt;
                    &lt;/body&gt;
                  &lt;/html&gt;

              </code>
          </pre>
      </div>
    </p>
    <p>
      I want you to try this code.
      Visit a site like <a href="https://codesandbox.io">Code Sandbox</a>
      or <a href="https://codepen.io">CodePen</a>.
      The result of that code will be the same. Both sites will
      show, according to that script, that you clicked the button
      by "NaN" times.
    </p>

    <p>
      Why is this behavior going? Are we doing things wrong?
      Do we need to relearn the OOP concepts again? None of the
      2 latest questions.
    </p>
    <p>
      What we are facing here is the behavior of JavaScript itself.
      It's something we might not be aware of. It's something that,
      for the purposes stated here, we'll refer to as the "Context".
      Context is not like the scope. Context is something that comes
      to life once we are executing code. 
    </p>
    <p>
      The Context is the underlying reference from where the current
      bound function will work with. 
      In a simpler way, it is the reference to which the word <code>this</code>
      will point to, during execution.
    </p>
    <p>
      In other words, this means that you will truly and absolutely know
      what <code>this</code> is only during runtime (of course, this is if
      you are good as debugger).
    </p>
    <p>
      <strong>BUT!</strong>
      There's a way for you to know what the <code>this</code> context will
      be. Although, I must say, this is error prone, with the right attitude,
      and a good knowledge of the right tools, you'll be safe from cutting
      yourself (too much) in the process. The cornerstones for <code>this</code>
      are composed of two parts: the rules and exceptions of the <code>this</code>
      context.
    </p>
    <h3>
      Rules
    </h3>
    <p>
      There are 4 rules that reign over the <code>this</code>
      kingdom, each with its own name:
      <ol>
        <li>
          <h4>Default binding</h4>
          <p>
            This context binding is the one that fallbacks to the <code>global</code>
            object, or, in other words, mostly everything that lies in the global
            scope.
          </p>
          <p>
            Let's say we have the following code:
            <div class="code-section">
                <input type="checkbox" class="collapse-checkbox" id="collapse-5">
                <label class="collapse-toggle" for="collapse-5" title="Click to toggle expand/collapse">
                </label>
                <pre class="collapse-content">
                <code class="code language-javascript">
                  let name = "Steve"
                  function printMyName() {
                    console.log(this.name)
                  }

                  printMyName()
                </code>
              </pre>
            </div>

            Try this out. This will result with the string "Steve" in the console.
            The engine will look up for the closest context object to have the property
            <code>name</code>.

            <p>
              This rule also applies by depth:
              <div class="code-section">
                  <input type="checkbox" class="collapse-checkbox" id="collapse-6">
                  <label class="collapse-toggle" for="collapse-6" title="Click to toggle expand/collapse">
                  </label>
                  <pre class="collapse-content">
                  <code class="code language-javascript">
                    let name = "Steve"
                    function printName() {
                      function printGlobalName() {
                        console.log(this.name)
                      }
                      printGlobalName()
                    }
  
                    printName()
                  </code>
                </pre>
              </div>
            </p>
          </p>
        </li>
        <li>
          <h4>Implicit binding</h4>
          <p>
            This context binding is applied depending from where a particular function
            was called, including if this was called by an eligible context object. 
            You can call this the <code>call-site</code>. 
          </p>
          <p>Given the following code:</p>
          <div class="code-section">
              <input type="checkbox" class="collapse-checkbox" id="collapse-7">
              <label class="collapse-toggle" for="collapse-7" title="Click to toggle expand/collapse">
              </label>
              <pre class="collapse-content">
              <code class="code language-javascript">
                const GUEST = 0
                const CLIENT = 1
                const MASTER = 2
                function open(door) {
                  let opened = false
                  if(this.cardKey){
                    switch(door.id) {
                      case GUEST:
                        opened = this.cardKey === 'guest'
                          break
                        case CLIENT:
                          opened = this.cardKey === 'AKJboq38h48fhIB'
                          break
                        case MASTER:
                          opened = this.cardKey === 'master'
                          break
                      }
                    }
                    console.log(`Access ${opened ? 'Authorized' : 'denied'}`)
                    return opened
                  }
                  let cardKey = 'guest'
                  let clientCardKey = 'AKJboq38h48fhIB'

                  let guest = {
                    name: 'Tom',
                    position: 'Guest',
                    open,
                  }

                  let client = {
                    name: 'Jerry',
                    cardKey: clientCardKey,
                    position: 'Client',
                    open,
                  }

                  let janitor = {
                    name: 'Hank',
                    position: 'Janitor',
                    cardKey: 'master',
                    open,
                  }

                  let doors = 
                    {
                      guest: {
                        id: 0,
                        requiredCardKey: 'guest'
                      },
                      client:{
                        id: 1,
                        requiredCardKey: 'AKJboq38h48fhIB'
                      },
                      master:{
                        id: 2,
                        requiredCardKey: 'master'
                      }
                    }

                  client.open(doors.client)
                  janitor.open(doors.master)
                  guest.open(doors.guest) // Suspicious...
              </code>
            </pre>
          </div>
        </li>
        <li>
          <h4>
            Explicit Binding
          </h4>
          <p>
            This type of binding is the one that lets you, through a range of selected functions, apply a context object
            explicitly, allowing you to work the way you intend. Let's take the following example:
            <div class="code-section">
                <input type="checkbox" class="collapse-checkbox" id="collapse-8">
                <label class="collapse-toggle" for="collapse-8" title="Click to toggle expand/collapse">
                </label>
                <pre class="collapse-content">
                <code class="code language-javascript">
                  class Employee {
                    constructor(name, employeeCode) {
                      this.name = name
                      this.employeeCode = employeeCode
                    }

                    getEmployeeCode(){
                      return this.employeeCode
                    }
                  }


                  class Printer {
                    print() {
                      console.log(`${this.name}'s Code: ${this.employeeCode}`)
                    }
                  }

                  const printer = new Printer()
                  const john = new Employee('John', '129dgKi3')
                  const jack = new Employee('Jack', '1p209udc')

                  // Using 'apply'
                  printer.print.apply(john)
                  printer.print.apply(jack)

                  // And the same can be achieved with 'call'
                  printer.print.call(john)
                  printer.print.call(jack)
                </code>
              </pre>
            </div>
            <code>call</code> and <code>apply</code> let you define a context object or your choice and use it
            as the <code>this</code> of the function you are using. The difference between these functions is that,
            <code>call</code> will receive, as its first argument, the context object, followed by each of the original
            function's arguments, resembling its signature, while <code>apply</code> will receive, the context object as
            its first argument, and the second argument will be an array, resembling each of the original function's arguments,
            respectively, so, be careful on the second one.
          </p>
        </li>
      </ol>
    </p>

  </main>
  <script src="/for-the-north-static/public/javascript/prism.js"></script>
</body>
</html>